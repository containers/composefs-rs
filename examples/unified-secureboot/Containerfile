FROM fedora:42 AS base
RUN --mount=type=cache,target=/var/cache/libdnf5 <<EOF
    set -eux

    dnf -y install fedora-repos-archive
    dnf --setopt keepcache=1 install -y \
        btrfs-progs \
        composefs \
        dosfstools \
        kernel-6.16.9-200.fc42 \
        mokutil \
        openssh-server \
        policycoreutils-python-utils \
        sbsigntools \
        selinux-policy-targeted \
        skopeo \
        strace \
        systemd \
        systemd-boot-unsigned \
        systemd-ukify \
        util-linux
EOF

# --- Everything above this line should hopefully stay cached ---

COPY cfsctl /usr/bin
COPY extra /
COPY test-thing.fedora-42 /
RUN <<EOF
    set -eux

    systemctl enable systemd-networkd

    checkmodule -M -m -o /etc/composefs_workarounds.mod /etc/composefs_workarounds.te
    semodule_package -o /etc/composefs_workarounds.pp -m /etc/composefs_workarounds.mod
    semodule -i /etc/composefs_workarounds.pp

    passwd -d root
    mkdir /sysroot
EOF

FROM base AS kernel
RUN --mount=type=bind,from=base,target=/mnt/base <<EOF
    set -eux

    mkdir -p /tmp/sysroot/composefs
    COMPOSEFS_FSVERITY="$(cfsctl --repo /tmp/sysroot compute-id --bootable /mnt/base)"

    mkdir -p /etc/kernel /etc/dracut.conf.d
    echo "composefs=${COMPOSEFS_FSVERITY} rw" > /etc/kernel/cmdline
EOF
RUN --mount=type=cache,target=/var/cache/libdnf5 \
    --mount=type=secret,id=key \
    --mount=type=secret,id=cert <<EOF
    kernel-install add-all
EOF

FROM base AS bootable
COPY --from=kernel /boot /boot
